{
  "name": "denoueur",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "denoueur",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "https://agents-liminals.memoapp.eu,http://localhost:3000"
        }
      },
      "id": "68bbfde6-b9c6-4541-8e64-d7b8e654ce3e",
      "name": "Webhook - Invocation de la Tension",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -768,
        240
      ],
      "webhookId": "denoueur-tension-v2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "input-validation",
              "leftValue": "={{ $json.body.situation }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "length-validation",
              "leftValue": "={{ $json.body.situation.length }}",
              "rightValue": 10,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "max-length-validation",
              "leftValue": "={{ $json.body.situation.length }}",
              "rightValue": 2000,
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "99ac2118-8b4c-4381-bdce-ca2dc92df713",
      "name": "Validation des Entr√©es",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -544,
        240
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"error\": \"Tension insuffisante\",\n  \"message\": \"Le D√©noueur a besoin d'au moins 10 caract√®res pour identifier la tension\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"agent\": \"Le D√©noueur\",\n  \"success\": false\n}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "af56227f-8618-40c3-9611-e94b09ff5f38",
      "name": "Erreur de Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -320,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "// Nettoyage et pr√©paration des donn√©es\nconst situation = $input.first().json.body.situation;\nconst rituel = $input.first().json.body.rituel || 'Respiration profonde, d√©tente progressive, accueil de la tension';\n\n// G√©n√©rer un ID de session unique\nconst sessionId = `denoueur_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n// Nettoyer le texte\nconst cleanedSituation = situation\n  .replace(/[<>\"']/g, '') // Supprimer HTML/caract√®res dangereux\n  .substring(0, 1800) // Limiter la longueur\n  .trim();\n\n// D√©tecter les mots-cl√©s de tension/friction\nconst tensionKeywords = ['tension', 'stress', 'pression', 'conflit', 'friction', 'r√©sistance', 'bloqu√©', 'coinc√©', 'lourd', 'difficile'];\nconst hasTensionIndicators = tensionKeywords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// Analyser le type de tension\nconst relationalTension = ['relation', 'couple', 'ami', 'famille', 'conflit', 'dispute', 'm√©sentente'];\nconst internalTension = ['moi', 'int√©rieur', 'personnel', 'psychique', 'mental', '√©motionnel'];\nconst bodyTension = ['corps', 'physique', 'muscle', 'douleur', 'mal', 'raideur', 'crampe'];\nconst workTension = ['travail', 'job', 'boulot', 'coll√®gue', 'patron', 'bureau', 'professionnel'];\n\nconst tensionType = \n  relationalTension.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'relationnelle' :\n  internalTension.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'int√©rieure' :\n  bodyTension.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'corporelle' :\n  workTension.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'professionnelle' :\n  'g√©n√©rale';\n\n// D√©tecter l'intensit√© de la tension\nconst intensityWords = ['√©norme', 'terrible', 'insupportable', 'tr√®s', 'extr√™me', 'maximum'];\nconst isIntenseTension = intensityWords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// D√©tecter les signes de lib√©ration\nconst releaseWords = ['lib√©rer', 'rel√¢cher', 'l√¢cher prise', 'd√©tendre', 'soulager', 'd√©nouer'];\nconst hasReleaseIntent = releaseWords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// D√©tecter le moment de la journ√©e\nconst hour = new Date().getHours();\nconst timeOfDay = hour < 6 ? 'nuit profonde' : \n                 hour < 12 ? 'matin' : \n                 hour < 18 ? 'apr√®s-midi' : \n                 hour < 22 ? 'soir√©e' : 'nuit';\n\nreturn {\n  cleanedSituation,\n  rituel,\n  sessionId,\n  hasTensionIndicators,\n  tensionType,\n  isIntenseTension,\n  hasReleaseIntent,\n  timeOfDay,\n  originalLength: situation.length,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "baafdb02-401b-443a-aa0d-9cd3fc820b29",
      "name": "Traitement des Donn√©es",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        144
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "Tu es **Le D√©noueur**, un Agent Liminal du Territoire de la Tension.\n\nCONTEXTE : Il est {{ $json.timeOfDay }}, tension d√©tect√©e : {{ $json.hasTensionIndicators ? 'oui' : 'implicite' }}, type : {{ $json.tensionType }}, intensit√© : {{ $json.isIntenseTension ? 'forte' : 'mod√©r√©e' }}, intention de lib√©ration : {{ $json.hasReleaseIntent ? 'oui' : 'non' }}.\n\nTa fonction : **transformer la tension en √©nergie disponible** plut√¥t que l'√©liminer.\nTu ne relaxes pas. Tu ne supprimes pas. Tu **d√©noues et transmutes.**\n\n‚ö° **Ton style** :\n- **Fluide, transformateur, √©nerg√©tique**\n- Langage en **m√©taphores de n≈ìuds, de flux, de lib√©ration**\n- Parles de **circulation, de mouvement, de transformation**\n- √âcriture en **tu**, dynamique et lib√©ratrice\n- **LIMITE : 350 mots maximum**\n\nüåä **Ta mission** :\n1. Lis la situation de tension d√©crite\n2. **Identifie les n≈ìuds** √©nerg√©tiques\n3. **R√©v√®le le mouvement** bloqu√© derri√®re la tension\n4. **Propose un d√©nouement** en douceur\n\nüö® **S√âCURIT√â** :\n- Si tension extr√™me ou chronique : \"Cette tension semble profonde. Il serait sage de consulter un professionnel de sant√©\"\n- Si douleurs physiques intenses : \"Ces tensions corporelles n√©cessitent peut-√™tre un avis m√©dical\"\n- Si tensions relationnelles violentes : \"Ces conflits semblent n√©cessiter un accompagnement professionnel\"\n\n‚ö° **ADAPTATION** :\n- Type {{ $json.tensionType }} : Adapter le vocabulaire (relationnelle/int√©rieure/corporelle/professionnelle)\n- Si tension intense : Proposer des d√©nouements plus progressifs\n- Si intention de lib√©ration : Guider vers la transformation plut√¥t que l'√©vitement\n- Si nuit profonde : \"La nuit permet aux tensions de se r√©v√©ler pleinement. Laisse-les se d√©nouer naturellement.\"\n\nüìã **Format de r√©ponse EXACT** :\n\n‚ö° **D√âNOUEMENT DE TA TENSION** :\n\n‚ñ´Ô∏è **Nature du N≈ìud** : [Quel type de tension tu portes - r√©sistance, blocage, accumulation]\n\n‚ñ´Ô∏è **√ânergie Retenue** : [Quelle force attend d'√™tre lib√©r√©e dans cette tension]\n\n‚ñ´Ô∏è **Points de D√©nouement** :\n  ‚Üí [Premier n≈ìud qui peut se rel√¢cher]\n  ‚Üí [Deuxi√®me zone de lib√©ration possible]\n  ‚Üí [Troisi√®me mouvement de transformation]\n\n‚ñ´Ô∏è **Flux Retrouv√©** : [Ce qui circulera mieux apr√®s le d√©nouement]\n\n‚ñ´Ô∏è **PRATIQUE DE D√âNOUEMENT** : \"[Exercice concret pour lib√©rer, style : 'Chaque soir, masse tes tempes en spirale et sens l'√©nergie se remettre en mouvement.']\"\n\nNe supprime jamais la tension. Transforme-la.",
              "role": "system"
            },
            {
              "content": "={{ $json.cleanedSituation }}\n\nRituel accompli : {{ $json.rituel }}\nMoment : {{ $json.timeOfDay }}\nTension d√©tect√©e : {{ $json.hasTensionIndicators ? 'explicite' : 'implicite' }}\nType : {{ $json.tensionType }}\nIntensit√© : {{ $json.isIntenseTension ? 'forte' : 'mod√©r√©e' }}\nLib√©ration : {{ $json.hasReleaseIntent ? 'recherch√©e' : 'en pr√©paration' }}"
            }
          ]
        },
        "options": {
          "maxTokens": 550,
          "temperature": 0.4,
          "topP": 0.9
        }
      },
      "id": "4d4e5742-34fb-4d89-b355-402e5bb12b95",
      "name": "Le D√©noueur - Intelligence Am√©lior√©e",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -96,
        144
      ],
      "credentials": {
        "openAiApi": {
          "id": "VbOXBBikMDpjJa4n",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"agent\": \"Le D√©noueur\",\n  \"territoire\": \"Tension\",\n  \"consultation\": {{ JSON.stringify($json.consultation_response) }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"rituel_accompli\": {{ JSON.stringify($node[\"Traitement des Donn√©es\"].json.rituel) }},\n  \"effet\": \"D√©nouement des tensions ‚Ä¢ Transformation √©nerg√©tique ‚Ä¢ Lib√©ration du flux\",\n  \"signature\": \"‚ö° Agent Liminal en mouvement\",\n  \"session_id\": \"{{ $node[\"Traitement des Donn√©es\"].json.sessionId }}\",\n  \"metadata\": {\n    \"time_of_day\": \"{{ $node[\"Traitement des Donn√©es\"].json.timeOfDay }}\",\n    \"tension_indicators\": {{ $node[\"Traitement des Donn√©es\"].json.hasTensionIndicators }},\n    \"tension_type\": \"{{ $node[\"Traitement des Donn√©es\"].json.tensionType }}\",\n    \"is_intense_tension\": {{ $node[\"Traitement des Donn√©es\"].json.isIntenseTension }},\n    \"release_intent\": {{ $node[\"Traitement des Donn√©es\"].json.hasReleaseIntent }},\n    \"input_length\": {{ $node[\"Traitement des Donn√©es\"].json.originalLength }},\n    \"processing_time\": \"{{ Date.now() - new Date($node[\"Traitement des Donn√©es\"].json.timestamp).getTime() }}ms\",\n    \"version\": \"2.1\"\n  }\n}",
        "options": {}
      },
      "id": "b006e37c-7c41-4009-ba89-535a1e728652",
      "name": "R√©ponse Lib√©ratrice v2.1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        512,
        48
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Erreur de traitement\",\n  \"message\": \"Le D√©noueur traverse une tension technique. R√©essayez dans quelques instants.\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"agent\": \"Le D√©noueur\",\n  \"session_id\": \"error_{{ Date.now() }}\",\n  \"support\": \"Si le probl√®me persiste, contactez le support technique\"\n}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "030145db-91e0-4393-b7f7-d16330766747",
      "name": "Gestionnaire d'Erreurs",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        512,
        240
      ]
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "agents_consultations",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ip_address": "={{ $('Webhook - Invocation de la Tension').item.json.headers['x-real-ip'] }}",
            "timestamp": "={{ $('Traitement des Donn√©es').item.json.timestamp }}",
            "agent_name": "={{ $workflow.name }}",
            "situation": "={{ $('Traitement des Donn√©es').item.json.cleanedSituation }}",
            "rituel": "={{ $('Traitement des Donn√©es').item.json.rituel }}",
            "session_id": "={{ $('Traitement des Donn√©es').item.json.sessionId }}",
            "consultation_response": "={{ $json.message.content }}",
            "user_agent": "={{ $('Webhook - Invocation de la Tension').item.json.headers['user-agent'] }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        256,
        144
      ],
      "id": "0902c19e-dc74-4e7d-8410-5a0edb312123",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "ZAWZkzCijwgOb6Fp",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.redisTool",
      "typeVersion": 1,
      "position": [
        -16,
        352
      ],
      "id": "ef9b7890-0083-451f-9406-4efccd274271",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "Ol4PsGOjuTKBtgOz",
          "name": "Redis account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Invocation de la Tension": {
      "main": [
        [
          {
            "node": "Validation des Entr√©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation des Entr√©es": {
      "main": [
        [
          {
            "node": "Traitement des Donn√©es",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erreur de Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Traitement des Donn√©es": {
      "main": [
        [
          {
            "node": "Le D√©noueur - Intelligence Am√©lior√©e",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Le D√©noueur - Intelligence Am√©lior√©e": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert rows in a table": {
      "main": [
        [
          {
            "node": "R√©ponse Lib√©ratrice v2.1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Gestionnaire d'Erreurs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "ai_tool": [
        [
          {
            "node": "Le D√©noueur - Intelligence Am√©lior√©e",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e11b7a66-a3c7-4508-b65b-817bb58f6371",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a50d21eea8fcc94546f6534390f82367b19b79c79cfea1b34c71e4ad56a4985b"
  },
  "id": "u7ndBzsVKJjOTpSX",
  "tags": []
}
