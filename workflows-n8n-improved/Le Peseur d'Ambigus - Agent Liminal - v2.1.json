{
  "name": "peseur",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "peseur",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "https://agents-liminals.memoapp.eu,http://localhost:3000"
        }
      },
      "id": "d7996dae-35a3-4f07-9eb3-f377c885caf6",
      "name": "Webhook - Invocation du Doute",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        192
      ],
      "webhookId": "peseur-ambigus-v2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "input-validation",
              "leftValue": "={{ $json.body.situation }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "length-validation",
              "leftValue": "={{ $json.body.situation.length }}",
              "rightValue": 10,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "max-length-validation",
              "leftValue": "={{ $json.body.situation.length }}",
              "rightValue": 2000,
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "297bb8f0-ce64-4cd8-b8d7-13cb45f73768",
      "name": "Validation des Entr√©es",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        224,
        192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"error\": \"Ambigu√Øt√© insuffisante\",\n  \"message\": \"Le Peseur d'Ambigus a besoin d'au moins 10 caract√®res pour √©valuer le doute\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"agent\": \"Le Peseur d'Ambigus\",\n  \"success\": false\n}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "def3409a-92ba-4bbd-9b53-11a99f7a0cef",
      "name": "Erreur de Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        448,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "// Nettoyage et pr√©paration des donn√©es\nconst situation = $input.first().json.body.situation;\nconst rituel = $input.first().json.body.rituel || 'Balance int√©rieure, respiration √©quilibr√©e, pes√©e des options';\n\n// G√©n√©rer un ID de session unique\nconst sessionId = `peseur_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n// Nettoyer le texte\nconst cleanedSituation = situation\n  .replace(/[<>\"']/g, '') // Supprimer HTML/caract√®res dangereux\n  .substring(0, 1800) // Limiter la longueur\n  .trim();\n\n// D√©tecter les mots-cl√©s de doute/ambigu√Øt√©\nconst doubtKeywords = ['doute', 'h√©sit', 'sais pas', 'tiraill√©', 'entre', 'choisir', 'd√©cision', 'ambig', 'incertain', 'balance'];\nconst hasDoubtIndicators = doubtKeywords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// Analyser le type de choix\nconst relationshipChoice = ['relation', 'couple', 'amour', 'ami', 'famille', 'partir', 'rester'];\nconst careerChoice = ['travail', 'job', 'carri√®re', 'm√©tier', 'boulot', 'emploi', 'profession'];\nconst lifeChoice = ['vie', 'd√©m√©nag', 'voyag', 'changement', 'nouvelle', 'direction'];\nconst valueChoice = ['valeur', 'principe', 'moral', '√©thique', 'bien', 'mal', 'juste'];\n\nconst choiceType = \n  relationshipChoice.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'relationnel' :\n  careerChoice.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'professionnel' :\n  lifeChoice.some(word => cleanedSituation.toLowerCase().includes(word)) ? 'existentiel' :\n  valueChoice.some(word => cleanedSituation.toLowerCase().includes(word)) ? '√©thique' :\n  'g√©n√©ral';\n\n// D√©tecter l'urgence de la d√©cision\nconst urgencyWords = ['urgent', 'rapidement', 'vite', 'maintenant', 'press√©', 'deadline'];\nconst isUrgentChoice = urgencyWords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// D√©tecter les peurs li√©es au choix\nconst fearWords = ['peur', 'angoisse', 'stress', 'inquiet', 'crainte', 'terrifie'];\nconst hasFearIndicators = fearWords.some(word => cleanedSituation.toLowerCase().includes(word));\n\n// D√©tecter l'√©quilibre temporel\nconst hour = new Date().getHours();\nconst timeOfDay = hour < 6 ? 'nuit profonde' : \n                 hour < 12 ? 'matin' : \n                 hour < 18 ? 'apr√®s-midi' : \n                 hour < 22 ? 'soir√©e' : 'nuit';\n\nreturn {\n  cleanedSituation,\n  rituel,\n  sessionId,\n  hasDoubtIndicators,\n  choiceType,\n  isUrgentChoice,\n  hasFearIndicators,\n  timeOfDay,\n  originalLength: situation.length,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "1bd5a760-0621-4bd4-8ff4-e9a3d509745d",
      "name": "Traitement des Donn√©es",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        96
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "Tu es **Le Peseur d'Ambigus**, un Agent Liminal du Territoire du Doute.\n\nCONTEXTE : Il est {{ $json.timeOfDay }}, doute d√©tect√© : {{ $json.hasDoubtIndicators ? 'oui' : 'implicite' }}, type : {{ $json.choiceType }}, urgence : {{ $json.isUrgentChoice ? '√©lev√©e' : 'normale' }}, peurs pr√©sentes : {{ $json.hasFearIndicators ? 'oui' : 'non' }}.\n\nTa fonction : **r√©v√©ler la sagesse de l'ambigu√Øt√©** plut√¥t que forcer le choix.\nTu ne tranches pas. Tu ne conseilles pas. Tu **p√®ses et √©quilibres.**\n\n‚öñÔ∏è **Ton style** :\n- **√âquilibr√©, mesur√©, nuanc√©**\n- Langage en **m√©taphores de balance, de poids, d'√©quilibre**\n- Parles de **tension cr√©atrice, d'entre-deux f√©cond**\n- √âcriture en **tu**, pond√©r√©e et juste\n- **LIMITE : 350 mots maximum**\n\n‚öóÔ∏è **Ta mission** :\n1. Lis la situation d'ambigu√Øt√© d√©crite\n2. **Identifie les poids** de chaque option\n3. **R√©v√®le la richesse** de l'ind√©cision\n4. **Propose un √©quilibre** pour habiter le doute\n\nüö® **S√âCURIT√â** :\n- Si angoisse de d√©cision extr√™me : \"Cette tension semble √©crasante. Il pourrait √™tre sage de consulter un psychologue pour t'accompagner\"\n- Si paralysie d√©cisionnelle totale : \"Cette paralysie m√©rite attention professionnelle. Contacte un th√©rapeute\"\n- Si d√©tresse li√©e aux choix : \"Cette d√©tresse est importante. Appelle SOS Amiti√© : 09 72 39 40 50\"\n\n‚öñÔ∏è **ADAPTATION** :\n- Type {{ $json.choiceType }} : Adapter le vocabulaire (relationnel/professionnel/existentiel/√©thique)\n- Si choix urgent : Rappeler que l'urgence peut troubler la balance\n- Si peurs pr√©sentes : Int√©grer les craintes dans la pes√©e\n- Si nuit profonde : \"La nuit amplifie les questionnements. Laisse-la r√©v√©ler tous les poids en pr√©sence.\"\n\nüìã **Format de r√©ponse EXACT** :\n\n‚öñÔ∏è **PES√âE DE TON AMBIGU√èT√â** :\n\n‚ñ´Ô∏è **Nature de la Balance** : [Quel type d'√©quilibre tu cherches - choix, valeurs, directions]\n\n‚ñ´Ô∏è **Poids en Pr√©sence** : [Quelles forces s'√©quilibrent dans ta situation]\n\n‚ñ´Ô∏è **Richesses de l'Entre-Deux** :\n  ‚Üí [Premier tr√©sor cach√© dans l'ind√©cision]\n  ‚Üí [Deuxi√®me sagesse que r√©v√®le l'ambigu√Øt√©]\n  ‚Üí [Troisi√®me force qui na√Æt de la tension]\n\n‚ñ´Ô∏è **Point d'√âquilibre** : [Ce que cette ambigu√Øt√© t'invite √† d√©velopper]\n\n‚ñ´Ô∏è **PRATIQUE DE PES√âE** : \"[Exercice concret pour habiter l'ambigu√Øt√©, style : 'Chaque jour, pose tes deux mains sur ton c≈ìur et sens quel poids r√©sonne en toi.']\"\n\nNe r√©sous jamais l'ambigu√Øt√©. R√©v√®le sa justesse.",
              "role": "system"
            },
            {
              "content": "={{ $json.cleanedSituation }}\n\nRituel accompli : {{ $json.rituel }}\nMoment : {{ $json.timeOfDay }}\nDoute d√©tect√© : {{ $json.hasDoubtIndicators ? 'explicite' : 'implicite' }}\nType : {{ $json.choiceType }}\nUrgence : {{ $json.isUrgentChoice ? '√©lev√©e' : 'normale' }}\nPeurs : {{ $json.hasFearIndicators ? 'pr√©sentes' : 'absentes' }}"
            }
          ]
        },
        "options": {
          "maxTokens": 550,
          "temperature": 0.4,
          "topP": 0.9
        }
      },
      "id": "a49e2e0e-485f-471d-9332-6f71a2043f4e",
      "name": "Le Peseur - Intelligence Am√©lior√©e",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        672,
        96
      ],
      "credentials": {
        "openAiApi": {
          "id": "VbOXBBikMDpjJa4n",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"agent\": \"Le Peseur d'Ambigus\",\n  \"territoire\": \"Doute\",\n  \"consultation\": {{ JSON.stringify($json.message.content) }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"rituel_accompli\": {{ JSON.stringify($node[\"Traitement des Donn√©es\"].json.rituel) }},\n  \"effet\": \"Pes√©e des ambigu√Øt√©s ‚Ä¢ √âquilibre int√©rieur ‚Ä¢ Sagesse de l'entre-deux\",\n  \"signature\": \"‚öñÔ∏è Agent Liminal en √©quilibre\",\n  \"session_id\": \"{{ $node[\"Traitement des Donn√©es\"].json.sessionId }}\",\n  \"metadata\": {\n    \"time_of_day\": \"{{ $node[\"Traitement des Donn√©es\"].json.timeOfDay }}\",\n    \"doubt_indicators\": {{ $node[\"Traitement des Donn√©es\"].json.hasDoubtIndicators }},\n    \"choice_type\": \"{{ $node[\"Traitement des Donn√©es\"].json.choiceType }}\",\n    \"is_urgent_choice\": {{ $node[\"Traitement des Donn√©es\"].json.isUrgentChoice }},\n    \"fear_indicators\": {{ $node[\"Traitement des Donn√©es\"].json.hasFearIndicators }},\n    \"input_length\": {{ $node[\"Traitement des Donn√©es\"].json.originalLength }},\n    \"processing_time\": \"{{ Date.now() - new Date($node[\"Traitement des Donn√©es\"].json.timestamp).getTime() }}ms\",\n    \"version\": \"2.1\"\n  }\n}",
        "options": {}
      },
      "id": "491172e2-5236-4f22-b05d-436b97bcb9d9",
      "name": "R√©ponse √âquilibr√©e v2.1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1280,
        0
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Erreur de traitement\",\n  \"message\": \"Le Peseur d'Ambigus traverse un d√©s√©quilibre technique. R√©essayez dans quelques instants.\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\",\n  \"agent\": \"Le Peseur d'Ambigus\",\n  \"session_id\": \"error_{{ Date.now() }}\",\n  \"support\": \"Si le probl√®me persiste, contactez le support technique\"\n}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "31b0ee4b-3293-4c2e-91f5-abe38d0adf4c",
      "name": "Gestionnaire d'Erreurs",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1280,
        192
      ]
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "agents_consultations",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ip_address": "={{ $('Webhook - Invocation du Doute').item.json.headers['x-real-ip'] }}",
            "timestamp": "={{ $('Traitement des Donn√©es').item.json.timestamp }}",
            "agent_name": "={{ $workflow.name }}",
            "situation": "={{ $('Traitement des Donn√©es').item.json.cleanedSituation }}",
            "rituel": "={{ $('Traitement des Donn√©es').item.json.rituel }}",
            "session_id": "={{ $('Traitement des Donn√©es').item.json.sessionId }}",
            "consultation_response": "={{ $json.message.content }}",
            "user_agent": "={{ $('Webhook - Invocation du Doute').item.json.headers['user-agent'] }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1024,
        96
      ],
      "id": "37972460-a423-4fd2-a63f-eb2207db935d",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "ZAWZkzCijwgOb6Fp",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Invocation du Doute": {
      "main": [
        [
          {
            "node": "Validation des Entr√©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation des Entr√©es": {
      "main": [
        [
          {
            "node": "Traitement des Donn√©es",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erreur de Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Traitement des Donn√©es": {
      "main": [
        [
          {
            "node": "Le Peseur - Intelligence Am√©lior√©e",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Le Peseur - Intelligence Am√©lior√©e": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert rows in a table": {
      "main": [
        [
          {
            "node": "R√©ponse √âquilibr√©e v2.1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Gestionnaire d'Erreurs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": []
}